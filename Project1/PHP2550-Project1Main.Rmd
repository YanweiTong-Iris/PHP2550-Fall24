---
title: "IMPACT OF ENVIRONMENTAL FACTORS ON MARATHON PERFORMANCE ACROSS AGE AND GENDER"
subtitle: "PHP2550 Project 1: An exploratory data analysis"
author: "Yanwei (Iris) Tong"
date: "2024-09-29"
output: 
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
link-citations: yes
header-includes:
   - "\\usepackage{xcolor}"
abstract: This exploratory study
bibliography: 0-references.bib
---

```{r setup, include=FALSE}
# Set up knit environment
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      error = FALSE)

# Load necessary packages
library(tidyverse)
library(kableExtra)
library(knitr)
library(ggplot2)
library(naniar)
library(gtsummary)
library(gt)
library(patchwork)
library(stargazer)
library(knitcitations)
library(mosaic)

# Define data path
data_path = "/Users/yanweitong/Documents/PHP2550-Data/Project1"

# Import datasets
main_data = read.csv(paste0(data_path, "/project1.csv"))
aqi_data = read.csv(paste0(data_path, "/aqi_values.csv"))
record_data = read.csv(paste0(data_path, "/course_record.csv"))
```

```{r}
# Merge main and record data sets
record_data <- record_data %>%
  mutate(Sex = ifelse(Gender == "F", 0, 1)) %>%
  mutate(Race_code = case_when(Race == "B"~0,
                               Race == "C"~1,
                               Race == "NY"~2,
                               Race == "TC"~3,
                               Race == "D" ~4))

merged_main <- main_data %>%
  left_join(record_data[, c("Year", "Sex", "CR", "Race_code")], 
            by = c("Race..0.Boston..1.Chicago..2.NYC..3.TC..4.D." = "Race_code", 
                   "Year" = "Year",
                   "Sex..0.F..1.M." = "Sex")) %>%
  dplyr::rename(Race_code = Race..0.Boston..1.Chicago..2.NYC..3.TC..4.D.,
         Sex = Sex..0.F..1.M.,
         Age = Age..yr.,
         SR = SR.W.m2) %>%
  mutate(Gender = factor(ifelse(Sex == 0, "Female", "Male"))) %>%
  mutate(Marathon = case_when(Race_code == 0 ~ "Boston",
                          Race_code == 1~ "NYC",
                          Race_code == 2 ~ "Chicago",
                          Race_code == 3 ~ "Twin Cities",
                          Race_code == 4 ~ "Grandmas")) %>%
  mutate(Flag = factor(Flag, 
                       levels = c("White", "Green", "Yellow", "Red", "Black")))  %>%
  mutate(FinishTime = as.numeric(as.difftime(CR, units = "mins") * (1+X.CR/100))) %>%
  mutate(Age_Group = cut(Age, breaks = c(0, 14, 19, 29, 39, 49, 59, 69, 79, 92),
                         labels = c("<= 14", "15-19", "20-29", "30-39", 
                                    "40-49", "50-59", "60-69", "70-79", ">= 80"), 
                         right = TRUE))


#Clean up AQI by CBSA
aqi_data = aqi_data %>% 
  distinct()

AP_mean = aqi_data %>%
  group_by(marathon, date_local, parameter, sample_duration) %>%
  summarise(daily_mean = mean(arithmetic_mean, na.rm = TRUE)) %>%
  mutate(parameter_duration = paste0(parameter, "-", sample_duration)) 


AP_pivot = AP_mean[,c("marathon", "date_local", "parameter_duration", "daily_mean")] %>%
  pivot_wider(names_from = parameter_duration, values_from = daily_mean) %>%
  mutate(Year = year(date_local)) %>%
  mutate(PM2.5 = coalesce(`PM2.5 - Local Conditions-24 HOUR`, 
                     `PM2.5 - Local Conditions-24-HR BLK AVG`))%>%
  dplyr::select(
    "marathon",
    "date_local",
    "Year",
    "Sulfur dioxide-1 HOUR",
    "Ozone-1 HOUR",
    "Nitrogen dioxide (NO2)-1 HOUR",
    "PM2.5"
  ) %>% 
  rename("SO2" = "Sulfur dioxide-1 HOUR",
         "NO2" = "Nitrogen dioxide (NO2)-1 HOUR",
         "Ozone" = "Ozone-1 HOUR")

merged_main = merged_main %>% 
  left_join(AP_pivot, 
            by = c("Marathon" = "marathon",
                   "Year" = "Year")) 
```


## \textcolor{orange}{INTRODUCTION}
The relationship between environmental factors and marathon performance has been the subject of extensive research. @ely2007impact has shown that increasing Wet Bulb Globe Temperature (WBGT) negatively affects overall speed. Interestingly, the impact of weather appears less pronounced for female runners, as @vihma2010effects noted, suggesting potential physiological or pacing differences. @deaner2015men further emphasized that men are more likely than women to slow over the course of a marathon, possibly due to pacing strategies or differences in heat tolerance. Age also plays a critical role, with older runners exhibiting less variance in marathon pace compared to younger participants, indicating a steadier pacing strategy (@nikolaidis2019fast). However, environmental stressors like higher temperatures and humidity affect both older male and female runners, as shown in the New York City Marathon, where they experienced significant performance declines (@knechtle2021role). Beyond heat, air temperature and pollution also factor into performance outcomes. @el2012impact demonstrated that the relationship between air temperature and marathon performance follows a quadratic trend, with optimal running temperatures varying by performance level. As temperatures exceed these optimal ranges, performance declines and withdrawal rates increase, with Ozone (O$_3$) levels potentially compounding these effects. Together, these studies underscore the complex interplay of environmental conditions, age, and gender on marathon performance, highlighting the need for a comprehensive examination of how these factors influence endurance running across diverse populations. Therefore, in this project, we would like to identify and explore the impacts of the following factors on marathon performance across genders: 1) the increase in age, 2) environmental conditions and whether the impact differs across age and gender, and 3) 

## \textcolor{orange}{METHODS}
### Data Overview
```{r}
# Baseline summary
merged_main %>%
  select(
    Marathon,
    Gender, 
    Age
  ) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    by = Marathon,
    digits = all_continuous() ~ 2,
    missing = "no",
    type = list(
      Gender ~ "categorical"
    )
  ) %>%
  add_p() %>%
  modify_caption(caption = "Participant Characteristics by Marathon, N = {N}") %>%
  as_kable_extra(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = ""
  ) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 8
  )

```

```{r, fig.width = 12, fig.height = 5}
dist_plot <- ggplot(merged_main %>% filter(Age >= 15), aes(x = X.CR, fill = Gender)) +
  geom_histogram(
    position = "identity",
    binwidth = 10,
    alpha = 0.6,
    color = NA
  ) +
  scale_fill_manual(values = c("Female" = "lightcoral", "Male" = "lightblue")) +
  facet_wrap( ~ Age_Group, scales = "free_y", nrow = 2) +
  theme_minimal() +
  labs(title = "Marathon Performance Distribution by Gender and Age Group", 
       x = "Percent off current course record", y = "Count") +
  theme(
    strip.text = element_text(face = "bold"),
    # Facet titles bold
    plot.title = element_text(hjust = 0.5, size = 16),
    # Centered title
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    legend.title = element_blank(),
    # Remove legend title
    legend.position = "bottom"
  )
dist_plot
```

```{r}
merged_main  %>%
  dplyr::select(
    Marathon,
    WBGT,
    Flag,
    Wind,
    X.rh,
    SR,
    NO2,
    SO2,
    Ozone,
    PM2.5
  ) %>%
  distinct() %>%
  tbl_summary(
    statistic = list(all_continuous() ~ c("{mean} ({sd})", "{min}, {max}"),
                     all_categorical() ~ "{n} ({p}%)"),
    by = Marathon,
    digits = all_continuous() ~ 2,
    missing = "no",
    type = list(
      WBGT ~ "continuous2",
      Flag ~ "categorical",
      X.rh ~ "continuous2",
      SR ~ "continuous2",
      Wind ~"continuous2",
      SO2  ~"continuous2",
      NO2 ~"continuous2",
      Ozone ~"continuous2",
      PM2.5 ~"continuous2"
    ),
    label = list(
      WBGT = "WBGT (°C)",
      Flag = "WBGT flag",
      X.rh = "Percent relative humidity",
      Wind = "Wind speed (Km/hr)",
      SR = "Solar radiation (W/m^2)",
      NO2 = "NO2 (ppb)",
      SO2 = "SO2 (ppb)",
      Ozone = "O3 (ppm)",
      PM2.5 = "PM2.5 (microgram/m^3)"
    )
  ) %>%
   modify_caption(caption = "Summary of Environmental Factors by Marathon, N = {N}") %>%
  as_kable_extra(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = "",
    format = "latex"
  ) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 8
  )
```

```{r, fig.height = 4, fig.width = 6}
all_environ_factors = c("Ozone", "PM2.5", "SO2", "NO2", "WBGT", "Wind", "DP", 
                        "Td..C", "Tw..C", "X.rh", "Tg..C", "SR")
environ_data <- merged_main[, all_environ_factors]

custom_labels <- c("Ozone", "PM2.5", "SO2", "NO2", "WBGT", "Wind Speed", "Dew Point", 
                   "Dry bulb temperature (°C)", "Tw (°C)", 
                   "%relative humidity", "Tg (°C)", "Solar Radiation")


cor_matrix <- cor(environ_data, use = "complete.obs", method = "pearson")
colnames(cor_matrix) <- custom_labels
rownames(cor_matrix) <- custom_labels

corrplot::corrplot(cor_matrix, 
                   type = "lower", 
                   method = "color", 
                   tl.cex = 0.6,      
                   tl.labels = custom_labels,  
                   tl.col = "black",   
                   col = colorRampPalette(c("darkblue", "beige", "brown"))(200),
                   addCoef.col = "black",  
                   number.cex = 0.5,
                   number.font = 1.3
)
```



### Statistical Analysis

## \textcolor{orange}{RESULTS}

```{r, fig.width = 8, fig.height = 3}
off_record_gender_age = ggplot(merged_main, aes(x = Age, y = X.CR, color = Gender)) +
   geom_smooth(method = "loess", se = TRUE, size = 0.5) +   # Loess smoothing with 95% CI
  labs(
    title = "Percent off Current Course Record vs. Age",
    x = "Age (yrs)",
    y = "Percent off current course record "
  ) +
  scale_y_continuous(limits = c(0, 300)) +  
  scale_x_continuous(breaks = seq(10, 100, by = 10)) +
   scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_blank(), 
    legend.position = "none" 
  )

finish_time_gender_age = ggplot(merged_main, aes(x = Age, y = FinishTime, color = Gender)) +
   geom_smooth(method = "loess", se = TRUE, size = 0.5) +   
  labs(
    title = "Finish Time vs. Age",
    x = "Age (yrs)",
    y = "Finish time (minutes)"
  ) +
  scale_x_continuous(breaks = seq(10, 100, by = 10)) +
   scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_blank(), 
    legend.position = "right" 
  )

off_record_gender_age + finish_time_gender_age
```

```{r, fig.width = 12, fig.height = 3.5}
# List of pollutant variables and their labels
weather <- c("Wind", "WBGT", "SR", "X.rh")
weather_titles <- c("Wind speed", "Wet Bulb Globe Temperature", 
            "Solar radiation ", "Percent relative humidity")
units <- c(" (Km/hr)", " (°C)", " (W/m^2)", "")

# Create a list of ggplot objects
plots <- lapply(seq_along(weather), function(i) {
  ggplot(merged_main, aes_string(x = weather[i], y = "X.CR" , color = "Gender")) +
    geom_smooth(method = "loess", se = TRUE, size = 1) +
    labs(
      title = weather_titles[i],
      x = paste0(weather[i], " ", units[i]),
      # Only show y-axis label on the first plot
      y = if (i == 1) "Best Time (%CR)" else NULL  
    ) +
    scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      axis.title.x = element_text(size = 14),
      axis.title.y = element_text(size = if (i == 1) 14 else 0),  # Hide y-axis title for other plots
      axis.text.y = element_text(size = if (i == 1) 12 else 0), # Hide y-axis text for other plots
      legend.position = if (i == 4) "right" else "none"
    )
})

# Combine the four plots into a single row with shared y-axis
combined_plot <- wrap_plots(plots, ncol = 4) & theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))
combined_plot
```

```{r, fig.width = 12, fig.height = 3.5}
# List of pollutant variables and their labels
pollutants <- c("Ozone", "NO2", "SO2", "PM2.5")
titles <- c("Ozone", "NO2", "SO2", "PM2.5")
units <- c(" (ppm)", " (ppb)", " (ppb)", "(microgram/m^3)")

# Create a list of ggplot objects
plots <- lapply(seq_along(pollutants), function(i) {
  ggplot(merged_main, aes_string(x = pollutants[i], y = "X.CR" , color = "Gender")) +
    geom_smooth(method = "loess", se = TRUE, size = 1) +
    labs(
      title = titles[i],
      x = paste0(pollutants[i], " ", units[i]),
      # Only show y-axis label on the first plot
      y = if (i == 1) "Best Time (%CR)" else NULL  
    ) +
    scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      axis.title.x = element_text(size = 14),
      axis.title.y = element_text(size = if (i == 1) 14 else 0),  # Hide y-axis title for other plots
      axis.text.y = element_text(size = if (i == 1) 12 else 0), # Hide y-axis text for other plots
      legend.position = if (i == 4) "right" else "none"
    )
})

# Combine the four plots into a single row with shared y-axis
combined_plot <- wrap_plots(plots, ncol = 4) & theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))
combined_plot
```



```{r, fig.height = 3.5, fig.width = 10}
ggplot(merged_main %>% filter(Age >= 15), aes(x = WBGT, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  scale_y_continuous(limits = c(0, 300)) + 
  labs(title = "Impact of WBGT on Marathon Performance by Gender and Age",
       x = "WBGT", y = "Percent off current course record") +
  theme_minimal() + 
  theme(legend.position = "none")

ggplot(merged_main %>% filter(Age >= 15), aes(x = NO2, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  scale_y_continuous(limits = c(0, 300)) + 
  labs(title = "Impact of NO2 on Marathon Performance by Gender and Age",
       x = "NO2 (ppm)", y = "Percent off current course record") +
  theme_minimal() + 
  theme(legend.position = "none")

# ggplot(merged_main %>% filter(Age >= 15), aes(x = PM2.5, y = X.CR, color = Gender)) +
#   geom_point(size = 0.3, alpha = 0.3) +
#   geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
#   facet_grid(Gender~Age_Group) +
#   scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
#   scale_y_continuous(limits = c(0, 300)) + 
#   labs(title = "Impact of PM2.5 on Marathon Performance by Gender and Age",
#        x = "PM2.5 (microgram/m^3)", y = "Percent off current course record") +
#   theme_minimal() +
#   theme(legend.position = "none")
```


```{r, fig.height = 4, fig.width = 12}
merged_main = merged_main %>% 
  mutate(Wind_s = scale(Wind),
         WBGT_s = scale(WBGT),
         SR_s = scale(SR),
         X.rh_s = scale(X.rh),
         Ozone_s = scale(Ozone),
         PM2.5_s = scale(PM2.5),
         SO2_s = scale(SO2),
         NO2_s = scale(NO2)
         )

lm.fit.weather = lm(log(FinishTime*60) ~ Gender + Age +
              Wind_s+ WBGT_s + SR_s+ X.rh_s,
            data = merged_main)
lm.fit.weather %>% tbl_regression()

lm.fit.AP = lm(log(FinishTime*60) ~ Gender + Age +
              Ozone_s + SO2_s + NO2_s + PM2.5_s,
            data = merged_main)
lm.fit.AP %>% tbl_regression()
```

```{r}
CR_merged = merged_main  %>%
  dplyr::select(
    Marathon,
    Gender,
    WBGT,
    Flag,
    Wind,
    X.rh,
    SR,
    NO2,
    SO2,
    Ozone,
    PM2.5,
    CR
  ) %>%
  distinct() 
```



## \textcolor{orange}{CONCLUSION}


## \textcolor{orange}{DISCUSSION}


\pagebreak
## Data Privacy and Code Availability

Primary data were provided by and Dr. Matthew Ely from the Department of Health Sciences at Providence College. The original data cannot be shared directly for privacy. Replication scripts are available at https://github.com/YanweiTong-Iris/PHP2550-Fall24/tree/main/Project1.

# Reference
<div id="refs"></div>

\pagebreak
## **Code Appendix**
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```


