---
title: "IMPACT OF ENVIRONMENTAL FACTORS ON MARATHON PERFORMANCE ACROSS AGE AND GENDER"
subtitle: "PHP2550 Project 1: An exploratory data analysis"
author: "Yanwei (Iris) Tong"
date: "2024-09-29"
output: 
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
link-citations: yes
header-includes:
   - "\\usepackage{xcolor}"
abstract: |
  \noindent 
  **Purpose:** The objectives of this exploratory study were to determine the effects of gender, age, and environmental stressors on marathon performance, and to identify the factors with maximal impacts.
  
  \noindent 
  **Methods:** We analyzed the results of 96 major marathon events in the U.S. from 1993 to 2016. LOESS plots, Spearman correlation test, GAM with a Gamma family, and other supplementary analyses were perfromed to visualize and investigate the non-linear effects of age, weather conditions, i.e., Wet Bulb Globe Temperatur (Â°C), wind speed (km/hr), solar radiation (W/m$^2$), percent relative humidity (\%), and the concentrations of 4 criteria air pollutants: PM$_{2.5}$ ($\mu$g/m$^3$), SO$_2$ (ppm), NO$_2$ (ppm), and O$_3$ (ppb) on marathon performance for all runners and record holders across genders. 
  
  \noindent 
  **Results and conclusion:**
  

csl: american-statistical-association.csl
bibliography: 0-references.bib
---

```{r setup, include=FALSE}
# Set up knit environment
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      error = FALSE)

# Load necessary packages
library(tidyverse)
library(kableExtra)
library(knitr)
library(ggplot2)
library(naniar)
library(gtsummary)
library(gt)
library(patchwork)
library(stargazer)
library(knitcitations)
library(mosaic)
library(summarytools)
library(npreg)
library(mgcv)


# Define data path
data_path = "/Users/yanweitong/Documents/PHP2550-Data/Project1"

# Import datasets
main_data = read.csv(paste0(data_path, "/project1.csv"))
aqi_data = read.csv(paste0(data_path, "/aqi_values.csv"))
record_data = read.csv(paste0(data_path, "/course_record.csv"))
```

```{r}
# Merge main and record data sets
record_data <- record_data %>%
  mutate(Sex = ifelse(Gender == "F", 0, 1)) %>%
  mutate(Race_code = case_when(Race == "B"~0,
                               Race == "C"~1,
                               Race == "NY"~2,
                               Race == "TC"~3,
                               Race == "D" ~4))

merged_main <- main_data %>%
  left_join(record_data[, c("Year", "Sex", "CR", "Race_code")], 
            by = c("Race..0.Boston..1.Chicago..2.NYC..3.TC..4.D." = "Race_code", 
                   "Year" = "Year",
                   "Sex..0.F..1.M." = "Sex")) %>%
  dplyr::rename(Race_code = Race..0.Boston..1.Chicago..2.NYC..3.TC..4.D.,
         Sex = Sex..0.F..1.M.,
         Age = Age..yr.,
         SR = SR.W.m2) %>%
  mutate(Gender = factor(ifelse(Sex == 0, "Female", "Male"))) %>%
  mutate(Marathon = case_when(Race_code == 0 ~ "Boston",
                          Race_code == 1~ "NYC",
                          Race_code == 2 ~ "Chicago",
                          Race_code == 3 ~ "Twin Cities",
                          Race_code == 4 ~ "Grandmas")) %>%
  mutate(Flag = factor(Flag, 
                       levels = c("White", "Green", "Yellow", "Red", "Black")))  %>%
  mutate(NetRaceTime = as.numeric(as.difftime(CR, units = "mins") * (1+X.CR/100))) %>%
  mutate(Age_Group = cut(Age, breaks = c(0, 14, 19, 29, 39, 49, 59, 69, 79, 92),
                         labels = c("<= 14", "15-19", "20-29", "30-39", 
                                    "40-49", "50-59", "60-69", "70-79", ">= 80"), 
                         right = TRUE))


#Clean up AQI by CBSA
aqi_data = aqi_data %>% 
  distinct()

AP_mean = aqi_data %>%
  group_by(marathon, date_local, parameter, sample_duration) %>%
  summarise(daily_mean = mean(arithmetic_mean, na.rm = TRUE)) %>%
  mutate(parameter_duration = paste0(parameter, "-", sample_duration)) 


AP_pivot = AP_mean[,c("marathon", "date_local", "parameter_duration", "daily_mean")] %>%
  pivot_wider(names_from = parameter_duration, values_from = daily_mean) %>%
  mutate(Year = year(date_local)) %>%
  mutate(PM2.5 = coalesce(`PM2.5 - Local Conditions-24 HOUR`, 
                     `PM2.5 - Local Conditions-24-HR BLK AVG`))%>%
  dplyr::select(
    "marathon",
    "date_local",
    "Year",
    "Sulfur dioxide-1 HOUR",
    "Ozone-1 HOUR",
    "Nitrogen dioxide (NO2)-1 HOUR",
    "PM2.5"
  ) %>% 
  rename("SO2" = "Sulfur dioxide-1 HOUR",
         "NO2" = "Nitrogen dioxide (NO2)-1 HOUR",
         "Ozone" = "Ozone-1 HOUR")

merged_main = merged_main %>% 
  left_join(AP_pivot, 
            by = c("Marathon" = "marathon",
                   "Year" = "Year")) %>% 
  mutate(Wind_s = scale(Wind),
         WBGT_s = scale(WBGT),
         SR_s = scale(SR),
         X.rh_s = scale(X.rh),
         Ozone_s = scale(Ozone),
         PM2.5_s = scale(PM2.5),
         SO2_s = scale(SO2),
         NO2_s = scale(NO2)
         ) %>% 
  mutate(log_X.CR = log(X.CR),
         log_NetRaceTime = log(NetRaceTime))

# For course records and environmental parameters only
CR_merged = merged_main  %>%
  dplyr::select(Marathon, CR, Gender, WBGT, Flag, Wind,
    X.rh, SR, NO2, SO2, Ozone, PM2.5, WBGT_s, Wind_s,
    X.rh_s, SR_s, NO2_s, SO2_s, Ozone_s, PM2.5_s) %>%
  distinct() %>%
  mutate(ChipTime = as.numeric(as.difftime(CR, units = "mins")))
```


## \textcolor{orange}{INTRODUCTION}
The relationship between environmental factors and marathon performance has been the subject of extensive research. @ely2007impact has shown that increasing Wet Bulb Globe Temperature (WBGT) negatively affects overall speed. Interestingly, the impact of weather appears less pronounced for female runners, as @vihma2010effects noted, suggesting potential physiological differences. @deaner2015men further emphasized that men are more likely than women to slow over the course of a marathon, possibly due to pacing strategies or differences in heat tolerance. Age also plays a critical role, with older runners exhibiting less variance in marathon pace compared to younger participants (@nikolaidis2019fast). However, environmental stressors like higher temperatures and humidity affect both older male and female runners, as shown in the New York City Marathon, where they experienced significant performance declines (@knechtle2021role). Beyond heat, air temperature and pollution also factor into performance outcomes. @el2012impact demonstrated that the relationship between air temperature and marathon performance follows a quadratic trend, with optimal running temperatures varying by performance level. As temperatures exceed these optimal ranges, performance declines and withdrawal rates increase, with Ozone (O$_3$) levels potentially compounding these effects. 

Together, these studies underscore the complex interplay of gender, age, and environmental conditions on marathon performance, highlighting the need for a comprehensive examination of how these factors influence endurance running. Therefore, in this project, by examining data from 5 major marathon races in the U.S., we would like to re-explore the effects and patterns of the following factors on marathon performance: 1) gender 2) the increase in age, and 3) environmental parameters, including weather conditions and air quality, and eventually to identify the parameters with the maximal impacts.


## \textcolor{orange}{METHODS}
### Data Overview

Marathon race results were obtained from five major U.S. marathons (Boston, Chicago, New York City, Grandmas, and Twin Cities) spanning the years 1993 to 2016. The total number of collected performances was 11,564 for the 96 races. The gender distribution was nearly even across all , with 47% female and 53% male participants across all events. The average age of runners varied slightly between marathons, ranging from 44 to 50 years, with the Twin Cities marathon hosting a slightly younger average age of participants compared to the others. Statistically significant differences in age were observed amongst races (p < 0.001).

```{r}
# Baseline summary
merged_main %>%
  select(
    Marathon,
    Gender, 
    Age
  ) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    by = Marathon,
    digits = all_continuous() ~ 2,
    missing = "no",
    type = list(
      Gender ~ "categorical"
    )
  ) %>%
  add_p() %>%
  modify_caption(caption = "Participant Characteristics by Marathon Race, N = {N}") %>%
  as_kable_extra(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = ""
  ) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 9
  )

```

Performance distributions, as illustrated in **Figure 1**, were right-skewed across all age groups, with most runners finishing closer to the course record, and a long tail of slower times, closely resembling the characteristics of Gamma distributions. This skewness is consistent across both genders, though differences in the central tendency of performance between men and women were observed within each age group. Given the non-normal distribution of net race times, transformations will be necessary (e.g., using log transform or Gamma family) in subsequent analyses to ensure more accurate modeling and interpretation of the factors influencing marathon performance. 

```{r, fig.width = 12, fig.height = 6}
dist_plot <- ggplot(merged_main %>% filter(Age >= 15), aes(x = X.CR, fill = Gender)) +
  geom_histogram(
    position = "identity",
    binwidth = 10,
    alpha = 0.6,
    color = NA
  ) +
  scale_fill_manual(values = c("Female" = "lightcoral", "Male" = "lightblue")) +
  facet_wrap( ~ Age_Group, scales = "free_y", nrow = 2) +
  theme_minimal() +
  labs(title = "Figure 1: Marathon Performance Distribution by Gender and Age Group", 
       x = "Percent off current course record", y = "Count") +
  theme(
    strip.text = element_text(face = "bold", size = 14),  
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "bottom"
  )
dist_plot
```

Relevant weather conditions of the 96 event dates were also provided. These are dry bulb temperature (Td, Â°C), wet bulb temperature (Tw, Â°C), percent relative humidity (%rh), black globe temperature (Tg, Â°C), solar radiation (SR, W/m$^2$), Dew Point (DP, Â°C), Wind speed (km/hr), and Wet Bulb Globe Temperature (WBGT,Â°C). WBGT was also categorized to 5 flag levels, quantifying risk of heat illness: White = WBGT <10C, Green = WBGT 10-18 Â°C, Yellow = WBGT >18-23 Â°C, Red = WBGT >23-28 Â°C, and Black = WBGT >28 Â°C. The air pollution concentrations of sulfur dioxide (parts per million), nitrogen dioxide (parts per million), ozone (parts per billion), and particular matter 2.5 ($\mu$g/m$^3$) were extracted from the EPA Meta Data using the `R` package `RAQSAPI`. SO$_2$, NO$_2$, and O$_3$ were derived from daily averages of 1-hour measurements, whereas PM$_{2.5}$ was based on a 24-hour measurement.

```{r, fig.width = 7}
#, out.width= "65%", out.extra='style="float:right; padding:10px"'
all_environ_factors = c("SO2", "NO2", "Ozone", "PM2.5", "WBGT", "Wind", "DP", 
                        "Td..C", "Tw..C", "X.rh", "Tg..C", "SR")
environ_data <- merged_main[, all_environ_factors]

custom_labels <- c( "SO2 (ppb)", "NO2 (ppb)", 
                    "Ozone (ppm)", "PM2.5 (microgram/m^3)",
                    "WBGT (Â°C)", "Wind Speed (km/hr)", "DP (Â°C)", 
                   "Td (Â°C)", "Tw (Â°C)", 
                   "%rh", "Tg (Â°C)", "SR (W/m^2)")


cor_matrix <- cor(environ_data, use = "complete.obs", method = "spearman")
colnames(cor_matrix) <- custom_labels
rownames(cor_matrix) <- custom_labels

corrplot::corrplot(cor_matrix, 
                   type = "lower", 
                   method = "color", 
                   tl.cex = 0.6,      
                   tl.labels = custom_labels,  
                   tl.col = "black",   
                   col = colorRampPalette(c("darkblue", "beige", "brown"))(200),
                   addCoef.col = "black",  
                   number.cex = 0.5,
                   number.font = 1.3
)
title("Figure 2: Correlation between Environmental Parameters", cex.main = 0.8)
```


**Figure 2** demonstrates the relationships between various environmental parameters. SO$_2$ and NO$_2$ exhibit a strong positive correlation (0.82), while ozone shows mild negative correlations with both SO$_2$ (-0.24) and NO$_2$ (-0.31). PM$_{2.5}$ correlates positively with SO$_2$ (0.51) and NO$_2$ (0.67), but less with ozone (0.12). These patterns may suggest different underlying pollution sources. Importantly, WBGT, which is a weighted average of dry bulb, wet bulb, and globe temperatures, expectedly shows strong correlations with DP (0.87), Td (0.97), Tw (0.98), and Tg (0.86). This high degree of correlation among temperature-related variables highlights the issue of multicollinearity. As WBGT integrates these components and represents overall thermal stress, further analyses will focus on WBGT as the primary temperature measure, thereby avoiding redundancy and potential co-linearity issues in the statistical models.

Regarding the distribution of the environmental parameters, the small p-values across **Table 2** indicate significant differences in weather conditions and air quality among the five major marathons. Variables such as WBGT, wind speed, humidity, and pollutants like NO$_2$ and SO$_2$ demonstrate considerable variability across locations, highlighting the unique environmental contexts in which each race was conducted. These findings suggest that environmental conditions may play a role in influencing marathon performance, particularly across different regions. **Figure 3** presents histograms of key environmental factors with levels of missingness. It shows that these variables are generally non-normal and with high variability. 

```{r}
merged_main  %>%
  dplyr::select(
    Marathon,
    WBGT,
    Flag,
    Wind,
    X.rh,
    SR,
    NO2,
    SO2,
    Ozone,
    PM2.5
  ) %>%
  distinct() %>%
  tbl_summary(
    statistic = list(all_continuous() ~ c("{mean} ({sd})", "{min}, {max}"),
                     all_categorical() ~ "{n} ({p}%)"),
    by = Marathon,
    digits = all_continuous() ~ 2,
    missing = "no",
    type = list(
      WBGT ~ "continuous2",
      Flag ~ "categorical",
      X.rh ~ "continuous2",
      SR ~ "continuous2",
      Wind ~"continuous2",
      SO2  ~"continuous2",
      NO2 ~"continuous2",
      Ozone ~"continuous2",
      PM2.5 ~"continuous2"
    ),
    label = list(
      WBGT = "WBGT (Â°C)",
      Flag = "WBGT flag",
      X.rh = "% relative humidity",
      Wind = "Wind speed (Km/hr)",
      SR = "SR (W/m^2)",
      NO2 = "NO2 (ppb)",
      SO2 = "SO2 (ppb)",
      Ozone = "O3 (ppm)",
      PM2.5 = "PM2.5 (microgram/m^3)"
    )
  ) %>% add_p() %>%
   modify_caption(caption = "Summary of Environmental Factors by Marathon, N = {N}") %>%
  as_kable_extra(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = "",
    format = "latex"
  ) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 8
  )
```

Moreover, most of the missingness in the dataset pertains to the air pollutant parameters, with NO$_2$ showing a missingness rate of 17.71\%, SO$_2$ at 16.67\%, and PM$_{2.5}$ at 21.88\%. These higher levels of missing data may present challenges to the robustness of subsequent analyses, particularly when assessing the impact of air quality on marathon performance. In contrast, the missingness rates for weather conditions are relatively low, approximately 4\%, and only 3\% for O$_3$, both of which satisfy the 5% rule of thumb, allowing for the safe assumption that ignoring these missing data will not significantly affect the overall results.

```{r, fig.width = 12, fig.height = 6}
distinct_environ = CR_merged[, c("WBGT", "X.rh", "Wind","SR", 
                                 "NO2", "SO2", "Ozone", "PM2.5")] %>%
  distinct()

custom_labels <- list(
  "X.rh" = "% relative humidity",
  "Wind" = "Wind Speed",
  "WBGT" = "WBGT",
  "SR" = "SR",
  "NO2" = "NO2",
  "SO2" = "SO2",
  "Ozone" = "Ozone",
  "PM2.5" = "PM2.5"
)

# Define a wrapper function to create a histogram for each environmental factor
create_histogram <- function(df, var_name) {
  missing_count <- sum(is.na(df[[var_name]]))
  total_count <- nrow(df)
  missing_percent <- (missing_count / total_count) * 100
  
  label <- custom_labels[[var_name]] %||% var_name
  
  ggplot(df, aes(x = .data[[var_name]])) +
    geom_histogram(bins = 10, fill = "lightblue", alpha = 0.7) +
    labs(title = label, x = "", 
         y = ifelse(var_name %in% c("WBGT", "NO2"), "Count", ""))+
      annotate(
        "text",
        x = Inf,
        y = Inf,
        label = paste0(
          "Missing: ", missing_count, "\n(",
          round(missing_percent, 2), "%)"
        ),
        hjust = 1.1,
        vjust = 1.6,
        size = 5,
        color = "#CC3333",
        fontface = "italic"
      ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = ifelse(var_name %in% c("WBGT", "NO2"), 12, 0)), 
      axis.text.y = element_text(size = ifelse(var_name %in% c("WBGT", "NO2"), 12, 0)) 
    ) 
}

environ_factors <- c("WBGT", "X.rh", "Wind", "SR", "NO2", "SO2", "Ozone", "PM2.5")

histograms <- lapply(environ_factors, 
                     function(var) create_histogram(distinct_environ, var))

combined_plot <- wrap_plots(histograms, ncol = 4,  scales = "free_x")+
  plot_annotation(
    title = "Figure 3: Distribution of Environmental Factors with Missingness",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 20))  
  )

print(combined_plot)

```


### Analysis Methods

In this exploratory study, we first employed locally estimated scatterplot smoothing (LOESS) to visually investigate the potential impact of age on marathon performance between genders and effects of various environmental factors  across different age-gender subgroups. These visualizations provided an initial overview of the relationships, highlighting any non-linear trends or differences in performance between genders or across age groups. 

A Spearman correlation test was then performed to quantitatively assess the overall associations between environmental variables and marathon performance, both for the entire cohort and for record-setting runners. Spearman correlation is suitable for capturing monotonic relationships without assuming normality, given that we knew non-lieanrity exists for most of the parameters and performance outcomes. 

Finally, to identify the most significant predictors and provide a more robust analysis, generalized additive models (GAMs) were fit using a Gamma family with a log link function. This approach allowed us to model non-linear effects while generating approximate F-values, p-values, and adjusted RÂ² for each environmental factor. This method enabled us to identify which factors exhibited the most significant influence on marathon performance, offering a more comprehensive understanding of the key environmental variables impacting both general and top-level performance.


## \textcolor{orange}{RESULTS}

**Figure 4** illustrates the relationship between age and marathon performance stratified by gender, measured in two different ways: percent off the current course record and net race time (minute). Consistent with findings from preliminary analyses, we observed a U-shaped relationship between age and %CR or race time. It implies that marathon performance improves with age during the early years, peaks around the 30s, and then declines thereafter. Notably, there is a clear distinction between male and female performance, with females generally performing slower than males. The pattern remains consistent regardless of how performance is measured. However, since the percent off course record metric already adjusts for gender, the performance gap between genders is narrower in that plot compared to the net race time plot.

```{r, fig.width = 6, fig.height = 3, fig.align='center'}
off_record_gender_age = ggplot(merged_main, 
                               aes(x = Age, y = X.CR, color = Gender)) +
  # Loess smoothing with 95% CI
   geom_smooth(method = "loess", se = TRUE, size = 0.5) +   
  labs(
    title = "Percent off Current Course Record vs. Age",
    x = "Age (yrs)",
    y = "Percent off current course record "
  ) +
  scale_y_continuous(limits = c(0, 300)) +  
  scale_x_continuous(breaks = seq(10, 100, by = 10)) +
   scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_blank(),
    legend.position = "none" 
  )

race_time_gender_age = ggplot(merged_main, aes(x = Age, 
                                               y = NetRaceTime, 
                                               color = Gender)) +
   geom_smooth(method = "loess", se = TRUE, size = 0.5) +   
  labs(
    title = "Net Race Time vs. Age",
    x = "Age (yrs)",
    y = "Net Race time (minutes)"
  ) +
  scale_x_continuous(breaks = seq(10, 100, by = 10)) +
   scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) + 
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_blank(), 
    legend.text = element_text(size = 6),
    legend.position = "right" 
  )

combined_plot <- wrap_plots(off_record_gender_age, race_time_gender_age, ncol = 2) +
  plot_annotation(
    title = "Figure 4: Impact of Age on Marathon Performance by Gender",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 10))  
  ) +
  plot_layout(ncol = 2, widths = c(1, 1.15)) & 
  theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))

combined_plot
```


To explore the impact of environmental conditions on marathon performance, we started with analyzing the overall correlations between various environmental factors and these two performance metrics: net race time in all runners (n = 11564) and the course records in minutes for all race events (n = 192). The results are displayed in **Table 3**. Overall, the correlations are relatively low. Among the environmental factors, WBGT showed the highest positive correlation with both net race time and course record, indicating that higher WBGT is associated with slower performances. Conversely, wind speed, solar radiation, and % relative humidity displayed negative correlations, suggesting that higher values of these factors may slightly improve performance, although the effect sizes are small. Interestingly, while NO$_2$ showed a very weak positive correlation with net race time in all runners (r = 0.0022), it had a stronger negative correlation with the course record (r = -0.118). Similar opposite directional patterns were observed for PM$_{2.5}$ and solar radiation, suggesting that the association between environmental factors and marathon performance may vary depending on whether we consider the entire field of runners or focus specifically on top performers (course record setters). This differential effect highlights the need for tailored analyses when assessing environmental impacts on performance across different levels of competitiveness. 

```{r}
cor_table <- data.frame(
  Environmental_Factor = environ_factors,
  NetRaceTime_Corr = NA,
  ChipTime_Corr = NA
)


for (i in seq_along(environ_factors)) {
  factor <- environ_factors[i]
  
  # Correlation for NetRaceTime for all runners
  cor_table$NetRaceTime_Corr[i] <- cor(merged_main[[factor]], 
                                       merged_main$NetRaceTime, 
                                       use = "complete.obs", 
                                       method = "spearman")
  
  # Correlation for ChipTime in records
  cor_table$ChipTime_Corr[i] <- cor(CR_merged[[factor]], 
                                    CR_merged$ChipTime, 
                                    use = "complete.obs", 
                                    method = "spearman")
}

colnames(cor_table)[2:3] <- c("Net race time in all runners", "Course record")
rownames(cor_table) <- c("WBGT", "%rh", "Wind Speed", "Solar Radiation", 
                         "NO2", "SO2", "Ozone", "PM2.5")
cor_table[, -1] %>%
  kable(caption = "Spearman Correlation between Environmental Factors and Net Race Time 
        for General Runners and Record Setters") %>%
    kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 10
  )

```


**Figure 5** illustrates the impact of various environmental factors on marathon performance, stratified by gender. Across all environmental factorsâincluding wind speed, WBGT, solar radiation, percent relative humidity, and air pollutants (Ozone, NO$_2$, SO$_2$, and PM$_{2.5}$)âthe effect of gender appears minimal, with male and female runners exhibiting similar patterns. The impact of environmental conditions on performance is notably non-linear, with clear curvatures visible across several variables, particularly WBGT and percent relative humidity. These results suggest complex interactions between environmental factors and performance, but without a significant difference in gender-specific responses.

```{r, fig.width = 12, fig.height = 3}
# List of pollutant variables and their labels
weather <- c("Wind", "WBGT", "SR", "X.rh")
weather_titles <- c("Wind speed", "Wet Bulb Globe Temperature", 
            "Solar radiation ", "Percent relative humidity")
units <- c(" (Km/hr)", " (Â°C)", " (W/m^2)", "")

# Create a list of ggplot objects
plots <- lapply(seq_along(weather), function(i) {
  ggplot(merged_main, aes_string(x = weather[i], y = "X.CR" , color = "Gender")) +
    geom_smooth(method = "loess", se = TRUE, size = 1) +
    labs(
      title = weather_titles[i],
      x = paste0(weather[i], " ", units[i]),
      # Only show y-axis label on the first plot
      y = if (i == 1) "Best Time (%CR)" else NULL  
    ) +
    scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      axis.title.x = element_text(size = 14),
      # Hide y-axis title and text for non-row-leading plots
      axis.title.y = element_text(size = if (i == 1) 14 else 0),  
      axis.text.y = element_text(size = if (i == 1) 12 else 0), 
      legend.position = if (i == 4) "right" else "none"
    )
})

# Combine the four plots into a single row with shared y-axis
combined_plot <- wrap_plots(plots, ncol = 4) & 
  theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) 

combined_plot <- combined_plot + 
  plot_annotation(
    title = "Figure 5: Impact of Environmental Factors on Marathon Performance by Gender using LOESS",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 16))  
  )

combined_plot
```

```{r, fig.width = 12, fig.height = 3}
# List of pollutant variables and their labels
pollutants <- c("Ozone", "NO2", "SO2", "PM2.5")
titles <- c("Ozone", "NO2", "SO2", "PM2.5")
units <- c(" (ppm)", " (ppb)", " (ppb)", "(microgram/m^3)")

# Create a list of ggplot objects
plots <- lapply(seq_along(pollutants), function(i) {
  ggplot(merged_main, aes_string(x = pollutants[i], y = "X.CR" , color = "Gender")) +
    geom_smooth(method = "loess", se = TRUE, size = 1) +
    labs(
      title = titles[i],
      x = paste0(pollutants[i], " ", units[i]),
      # Only show y-axis label on the first plot
      y = if (i == 1) "Best Time (%CR)" else NULL  
    ) +
    scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      axis.title.x = element_text(size = 14),
      # Hide y-axis title and text for non-row-leading plots
      axis.title.y = element_text(size = if (i == 1) 14 else 0),  
      axis.text.y = element_text(size = if (i == 1) 12 else 0),
      legend.position = if (i == 4) "right" else "none"
    )
})

# Combine the four plots into a single row with shared y-axis
combined_plot <- wrap_plots(plots, ncol = 4) & 
  theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))
combined_plot
```

Then, we broke the environmental impacts by both genders and age groups. Take the effects of WBGT and NO$_2$ as examples. For runners in the 20-59 year-old age groups, the two factors' influence on marathon performance appears to be minimal, as the regression line is nearly horizontal. In contrast, for both younger runners (15-19 years) and older runners (above 60 years), the relationship between WBGT or NO$_2$ and marathon performance seems more non-linear, with slight increases and decreases in performance with the increasing WBGT or increasing concentration of NO$_2$. Despite these age-specific trends, the overall patterns for men and women are remarkably similar, reiterating that gender does not significantly modify the relationship between environmental stressors and marathon performance.

```{r, fig.height = 7, fig.width = 9}
WBGT = ggplot(merged_main %>% filter(Age >= 15), aes(x = WBGT, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(x = "WBGT (Â°C)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")

NO2 = ggplot(merged_main %>% filter(Age >= 15), aes(x = NO2, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(x = "NO2 (ppm)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")

combined_plot <- WBGT / NO2 +
  plot_annotation(title = "Figure 6: the Impact of WBGT and NO2 on Marathon Performance",
                  theme = theme(plot.title = element_text(size = 14, hjust = 0.5)))

print(combined_plot)
```


```{r, fig.width = 12, fig.height =6}
std_environ_factors = c("Wind_s", "WBGT_s", "SR_s", "X.rh_s",
                        "Ozone_s", "SO2_s", "NO2_s", "PM2.5_s")

std_x_labels <- list(
  "X.rh_s" = "% relative humidity",
  "Wind_s" = "Wind Speed",
  "WBGT_s" = "WBGT",
  "SR_s" = "SR",
  "NO2_s" = "NO2",
  "SO2_s" = "SO2",
  "Ozone_s" = "Ozone",
  "PM2.5_s" = "PM2.5"
)

# Wrapper funct to fit GAM, create plot, and extract adjusted R-squared
create_gam_plot <- function(df, show_y_axis = TRUE, x_var, y_var = "X.CR") {
  
  # Filter out missing and non-finite values
  model_data <- df %>%
    filter(.data[[y_var]] > 0) %>%
    filter(!is.na(.data[[x_var]]) & !is.na(.data[[y_var]]) & 
             is.finite(.data[[x_var]]) & is.finite(.data[[y_var]]))
  
  gam_fit <- gam(as.formula(paste(y_var, "~ s(", x_var, ")")), 
                 data = model_data,
                 family = Gamma(link = "log"))
  
  adj_r2 <- summary(gam_fit)$r.sq  
  
  x_label <- paste0("Standardized ", std_x_labels[[x_var]] %||% x_var)
  ylab_text <- if (show_y_axis) "% off course record" else ""
  
  mar_setting <- if (show_y_axis) c(5, 4, 4, 2) else c(5, 1.5, 4, 2)
  par(mar = mar_setting)

  plot(gam_fit, se = TRUE, shade = TRUE, rug = FALSE, 
       xlab = " ", ylab = ylab_text, main = x_label, 
       cex.lab = if (show_y_axis) 1.5 else 0.1, cex.main = 1.5)
  
  # Add annotation for adjusted RÂ²
  legend(
    "topright",
    legend = paste0("Adj RÂ² = ", 100*round(adj_r2, 3), "%"),
    bty = "n",
    text.col = "#CC3333",
    cex = 1.5
  )
}

# Create all plots
# Set up a 2x4 plot layout with outer margins for title
par(mfrow = c(2, 4), oma = c(0, 0, 3, 0))  
for (i in seq_along(std_environ_factors)) {
  show_y_axis <- (i %% 4 == 1)  # Show y-axis only for the first plot in each row
  create_gam_plot(merged_main, x_var = std_environ_factors[i], 
                  y_var = "X.CR", show_y_axis = show_y_axis)
}
mtext("Figure 7: GAM Fits of Environmental Factors on % off Course Record", 
      outer = TRUE, cex = 1.5, font = 2) 
```


```{r}
# Data frame to store results
gam_results <- data.frame(
  Variable = character(),
  n = numeric(),
  F_value = numeric(),
  P_value = numeric(),
  Adj_R2 = numeric(),
  Deviance_Explained = numeric(),
  stringsAsFactors = FALSE
)


get_gam_info <- function(df, x_var, y_var = "X.CR") {
  
  # Filter data for valid values
  model_data <- df %>%
    filter(.data[[y_var]] > 0) %>%
    filter(!is.na(.data[[x_var]]) & !is.na(.data[[y_var]]) & 
             is.finite(.data[[x_var]]) & is.finite(.data[[y_var]]))
  
  gam_fit <- gam(as.formula(paste0(y_var, " ~ s(", x_var, ")")), 
                 data = model_data, family = Gamma(link = "log"))
  
  gam_summary <- summary(gam_fit)
  n <- gam_summary$n
  
  # Extracting approximate F-value and p-value for the smooth term
  smooth_terms <- gam_summary$s.table
  
  F_value <- smooth_terms[1, "F"]
  p_value <- smooth_terms[1, "p-value"]
  
  # Adjusted R-squared and deviance explained
  adj_r2 <- paste0(round(gam_summary$r.sq, 4) * 100, "%")
  deviance_explained <- paste0(round(gam_summary$dev.expl, 4)*100, "%") 
  
  return(
    list(
      n = n,
      F_value = round(F_value, 4),
      P_value = round(p_value, 4),
      Adj_R2 = adj_r2,
      Deviance_Explained = deviance_explained
    )
  )
}

for (x_var in std_environ_factors) {
  gam_info <- get_gam_info(merged_main, x_var)
  
  gam_results <- rbind(gam_results, data.frame(
    Variable = std_x_labels[[x_var]] %||% x_var,
    n = gam_info$n,
    F_value = gam_info$F_value,
    Approx_P_value = gam_info$P_value,
    Adj_R2 = gam_info$Adj_R2, 
    Deviance_Explained = gam_info$Deviance_Explained
  ))
}

colnames(gam_results) <- c("Standardized variable", "n","Approxi. F-value",
                           "Approxi. p-value", "Adj. R2", "% Dev. explained")

gam_results %>%
  kable(caption = "GAM Results- Percent off Course Record vs. Standardized Environmental Factors",
        align = "c") %>%
  kable_styling(full_width = FALSE,
                latex_options = c("striped", "repeat_header"),
                stripe_color = "gray!15",
                font_size = 10,
                position = "center")

```



## \textcolor{orange}{CONCLUSION}



## \textcolor{orange}{DISCUSSION}



## Data Privacy and Code Availability

Primary data were provided by Dr. Brett Romano Ely and Dr. Matthew Ely from the Department of Health Sciences at Providence College. The original data cannot be shared directly for privacy. Replication scripts are available at https://github.com/YanweiTong-Iris/PHP2550-Fall24/tree/main/Project1.

# Reference
<div id="refs"></div>

\pagebreak
# Plot Appendix
### Supplemental LOESS plots for the impact of environmental factors on performance by age and gender
```{r, fig.height = 3.5, fig.width = 9}
# Impact of environmental factors on performance by age and gender

ggplot(merged_main %>% filter(Age >= 15), aes(x = SR, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S1: The Impact of Solar Radiation on Marathon Performance by Age and Gender",
    x = "SR (W/m^2)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r, fig.height = 3.5, fig.width = 9}
ggplot(merged_main %>% filter(Age >= 15), aes(x = X.rh, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S2: The Impact of Percent Relative Humidity on Marathon Performance by Age and Gender",
    x = "SR (W/m^2)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r, fig.height = 3.5, fig.width = 9}
ggplot(merged_main %>% filter(Age >= 15), aes(x = Wind, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S3: The Impact of Wind Speed on Marathon Performance by Age and Gender",
    x = "Wind speed (km/hr)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r, fig.height = 3.5, fig.width = 9}
ggplot(merged_main %>% filter(Age >= 15), aes(x = SO2, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S4: The Impact of SO2 on Marathon Performance by Age and Gender", 
    x = "SO2 (ppm)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r, fig.height = 3.5, fig.width = 9}
ggplot(merged_main %>% filter(Age >= 15), aes(x = Ozone, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S5: The Impact of Ozone on Marathon Performance by Age and Gender", 
    x = "Ozone (ppb)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r, fig.height = 3.5, fig.width = 9}
ggplot(merged_main %>% filter(Age >= 15), aes(x = PM2.5, y = X.CR, color = Gender)) +
  geom_point(size = 0.3, alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE, size = 0.75, color = "black") +
  facet_grid(Gender~Age_Group) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "darkred")) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Figure S6: The Impact of PM2.5 on Marathon Performance by Age and Gender", 
    x = "PM2.5 (microgram/m^3)", y = "Percent off current course record") +
  theme_minimal() +
  theme(legend.position = "none")
```



\pagebreak
# Code Appendix
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```


