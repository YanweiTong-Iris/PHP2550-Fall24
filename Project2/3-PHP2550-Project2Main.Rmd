---
title: ""
subtitle: "PHP2550 Project 2: A regression analysis"
author: "Yanwei (Iris) Tong"
date: "2024-10-10"
output: 
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
link-citations: yes
header-includes:
   - "\\usepackage{xcolor}"
abstract: |
  **Purpose:** "to examine baseline variables as potential moderators of the effects of behavioral treatment on end-of-treatment (EOT) abstinence and evaluate baseline variables as predictors of abstinence, controlling for behavioral treatment and pharmacotherapy"
  **Methods:** 
  **Results and conclusion:** 
  
geometry: margin=1in
fontsize: 10.5pt
csl: american-statistical-association.csl
bibliography: 0-references.bib
---

```{r setup, include=FALSE}
# Set up knit environment
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      error = FALSE)

# Load necessary packages
library(tidyverse)
library(kableExtra)
library(knitr)
library(ggplot2)
library(naniar)
library(gtsummary)
library(gt)
library(patchwork)
library(stargazer)
library(knitcitations)
library(mosaic)
library(summarytools)
library(npreg)
library(mgcv)
library(glmnet)
library(pROC)
library(MASS)
library(survey)
```

```{r}
# Define data path and import data
data_path = "/Users/yanweitong/Documents/PHP2550-Data/Project2"
data = read.csv(paste0(data_path, "/project2.csv"))

# Data preprocessing
data = data  %>%
  # create race variable
  mutate(race = factor(case_when(
    NHW == 1 ~ "NHW",
    Black == 1 ~ "Black",
    Hisp == 1 ~ "Hispanic",
    TRUE ~ "Other"  # Handle cases where none of the above conditions are met
  ), levels = c("NHW", "Black", "Hispanic", "Other"))) %>%
  # create treatment categories
  mutate(treatment_cat = factor(case_when(BA == 1 & Var == 0 ~ "BASC+placebo",
                                   BA == 0 & Var == 0 ~ "ST+placebo",
                                   BA == 1 & Var == 1 ~ "BASC+varenicline",
                                   BA == 0 & Var == 1 ~ "ST+varenicline"))) %>% 
  # factorize categorical/ordinal variables
  mutate(
    abst = factor(abst),
    Var = factor(Var),
    BA = factor(BA),
    sex_ps = factor(sex_ps),
    ftcd.5.mins = factor(ftcd.5.mins),
    otherdiag = factor(otherdiag),
    antidepmed = factor(antidepmed),
    mde_curr = factor(mde_curr),
    Only.Menthol = factor(Only.Menthol),
    edu = factor(edu, levels = c(1, 2, 3, 4, 5),
                 labels = c("Grade school", 
                            "Some high school", 
                            "High school graduate or GED", 
                            "Some college/technical school", 
                            "College graduate")),
    inc = factor(inc, levels = c(1, 2, 3, 4, 5),
                 labels = c("Less than $20 000", 
                            "$20 000–35 000", 
                            "$35 001–50 000", 
                            "$50 001–75 000", 
                            "More than $75 000"))
  ) %>%
  # make integers numeric 
  mutate(across(
    .cols = where(is.integer) & !all_of("id"),
    .fns = as.numeric 
  ))

train_index <- sample(1:nrow(data), 0.7 * nrow(data))
```

## \textcolor{orange}{INTRODUCTION}

## \textcolor{orange}{METHODS}

### Data Overview
```{r}
# table1_data = data
# 
# # Demographics table
# demographics_table <- table1_data %>%
#   dplyr::select(
#     treatment_cat,
#     age_ps,
#     sex_ps,
#     race,
#     inc,
#     edu
#   ) %>%
#   tbl_summary(
#     by = treatment_cat,
#     label = list(
#       age_ps = "Age (years)",
#       sex_ps = "Sex",
#       race = "Race",
#       inc = "Income",
#       edu = "Education"
#     ),
#     type = list(
#       age_ps ~ "continuous",
#       sex_ps ~ "dichotomous",
#       race ~ "categorical",
#       inc ~ "categorical",
#       edu ~ "categorical"),
#     value = list(
#       sex_ps ~ "2"),
#     statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
#     digits = all_continuous() ~ 1,
#     missing = "no"
#   ) %>% add_overall() %>%
#   modify_header(label ~ "**Demographics**")
# 
# # Smoking table
# smoking_table <- table1_data %>%
#   dplyr::select(
#     treatment_cat,
#     cpd_ps,
#     ftcd_score,
#     ftcd.5.mins,
#     bdi_score_w00,
#     crv_total_pq1,
#     hedonsum_n_pq1,
#     hedonsum_y_pq1,
#     Only.Menthol,
#     readiness,
#     NMR
#   ) %>%
#   tbl_summary(
#     by = treatment_cat,
#     label = list(
#       cpd_ps = "Cigarettes per day at baseline phone survey",
#       ftcd_score = "FTCD score at baseline",
#       ftcd.5.mins = "Smoking within 5 mins of waking up",
#       bdi_score_w00 = "BDI score at baseline",
#       crv_total_pq1 = "Cigarette reward value at baseline",
#       hedonsum_n_pq1 = "Pleasurable Events Scale (substitute reinforcers)",
#       hedonsum_y_pq1 = "Pleasurable Events Scale (complementary reinforcers)",
#       Only.Menthol = "Exclusive Mentholated Cigarette User",
#       readiness = "Readiness to quit smoking",
#       NMR = "Nicotine Metabolism Ratio"
#     ), type = list(
#       cpd_ps ~ "continuous", 
#       ftcd_score ~ "continuous",
#       ftcd.5.mins ~ "categorical",
#       bdi_score_w00 ~ "continuous",
#       crv_total_pq1 ~ "continuous",
#       hedonsum_n_pq1 ~ "continuous",
#       hedonsum_y_pq1 ~ "continuous",
#       NMR ~ "continuous",
#       Only.Menthol ~ "categorical",
#       readiness ~ "continuous"),
#     statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
#     digits = all_continuous() ~ 1,
#     missing = "no"
#   ) %>% add_overall() %>%
#   modify_header(label ~ "**Smoking**")
# 
# # Psychiatric table
# psychiatric_table <- table1_data %>%
#   dplyr::select(
#     treatment_cat,
#     shaps_score_pq1,
#     otherdiag,
#     antidepmed,
#     mde_curr
#   ) %>%
#   tbl_summary(
#     by = treatment_cat,
#     label = list(
#       shaps_score_pq1 = "Anhedonia",
#       otherdiag = "Other lifetime DSM-5 diagnosis",
#       antidepmed = "Taking antidepressant medication at baseline",
#       mde_curr = "Current vs past MDD"
#     ), 
#     type = list(shaps_score_pq1 ~ "continuous", 
#       otherdiag ~ "dichotomous",
#       antidepmed ~ "dichotomous",
#       mde_curr ~ "dichotomous"),
#     value = list(otherdiag ~ "1",
#       antidepmed ~ "1",
#       mde_curr ~ "1"),
#     statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
#     digits = all_continuous() ~ 1,
#     missing = "no"
#   ) %>% add_overall() %>%
#   modify_header(label ~ "**Psychiatric**")
# 
# # Merge tables
# final_table <- tbl_merge(
#   tbls = list(demographics_table, smoking_table, psychiatric_table)
# ) %>%
#   modify_caption("Participant characteristics by treatment arm and overall sample") %>%
#   as_kable_extra(
#     booktabs = TRUE,
#     longtable = TRUE,
#     linesep = "",
#     format = "latex"
#   ) %>%
#   kable_styling(
#     position = "center",
#     latex_options = c("striped", "repeat_header"),
#     stripe_color = "gray!15",
#     font_size = 7
#   )
# 
# # Display the final table
# final_table
```

```{r}
# for sub-tab purpose
table1_data = data %>%
  mutate(
    Demographics = NA,
    Smoking = NA,
    Psychiatric = NA
  )
  
table1_data %>%
  dplyr::select(
    treatment_cat,
    Demographics,
    age_ps,
    sex_ps,
    race,
    inc,
    edu,
    Smoking,
    cpd_ps,
    ftcd_score,
    ftcd.5.mins,
    bdi_score_w00,
    crv_total_pq1,
    hedonsum_n_pq1,
    hedonsum_y_pq1,
    NMR,
    Only.Menthol,
    readiness,
    Psychiatric,
    shaps_score_pq1,
    otherdiag,
    antidepmed,
    mde_curr
  ) %>%
  tbl_summary(
    statistic = list(all_continuous() ~ c("{mean} ({sd})"),
                     all_categorical() ~ "{n} ({p}%)"),
    by = treatment_cat,
    digits = all_continuous() ~ 1,
    missing = "no",
    type = list(
      age_ps ~ "continuous",
      sex_ps ~ "dichotomous",
      race ~ "categorical",
      inc ~ "categorical",
      edu ~ "categorical",
      cpd_ps ~ "continuous", 
      ftcd_score ~ "continuous",
      ftcd.5.mins ~ "dichotomous",
      bdi_score_w00 ~ "continuous",
      crv_total_pq1 ~ "continuous",
      hedonsum_n_pq1 ~ "continuous",
      hedonsum_y_pq1 ~ "continuous",
      NMR ~ "continuous",
      Only.Menthol ~ "dichotomous",
      readiness ~ "continuous",
      shaps_score_pq1 ~ "continuous", 
      otherdiag ~ "dichotomous",
      antidepmed ~ "dichotomous",
      mde_curr ~ "dichotomous"
    ),
    label = list(
      age_ps = "Age (years)",
      sex_ps = "Sex ",
      race = "Race",
      inc = "Income",
      edu = "Education",
      cpd_ps = "Cigarettes per day",
      ftcd_score = "FTCD scoree",
      ftcd.5.mins = "Smoking with 5 mins of waking up",
      bdi_score_w00 = "BDI score",
      crv_total_pq1 = "Cigarette reward value",
      hedonsum_n_pq1 = "Pleasurable Events Scale (substitute)",
      hedonsum_y_pq1 = "Pleasurable Events Scale (complementary)",
      Only.Menthol = "Exclusive Mentholated Cigarette User",
      readiness = "Readiness to quit smoking",
      NMR = "Nicotine Metabolism Ratio",
      shaps_score_pq1 = "Anhedonia", 
      otherdiag = "Other lifetime DSM-5 diagnosis",
      antidepmed = "Antidepressant medication",
      mde_curr = "Current vs past MDD"
    ),
    value = list(
      sex_ps ~ "2",
      Only.Menthol ~ "1",
      otherdiag ~ "1",
      antidepmed ~ "1",
      mde_curr ~ "1",
      ftcd.5.mins ~ "1"
    )
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Characteristic**") %>%
  modify_caption(caption = "Participant characteristics by treatment arm and overall sample at baseline") %>%
  modify_table_body(
    ~ .x %>%
      mutate(across(everything(), ~ ifelse(. == "0 (NA%)", "", .)))
  ) %>%  
  modify_table_styling(
    rows = label %in% c("Demographics", "Smoking", "Psychiatric"),
    columns = label,
    text_format = "bold"
  )   %>%
  as_kable_extra(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = "",
    format = "latex"
  ) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = c("striped", "repeat_header"),
    stripe_color = "gray!15",
    font_size = 7
  )
```

```{r}
# Missingness table
# Calculate missing values for each variable
missing_summary <- data %>%
  summarise(across(everything(), ~ sum(is.na(.)), .names = "{col}")) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Number") %>%
  mutate(Pct = (Number / nrow(data)) * 100) %>%
  filter(Number > 0)  # Exclude variables with 0 missingness

# Define a named vector with old and new names for variables
variable_names <- c(
  "inc" = "Income",
  "ftcd_score" = "FTCD score at baseline",
  "crv_total_pq1" = "Cigarette reward value at baseline",
  "shaps_score_pq1" = "Anhedonia",
  "NMR" = "Nicotine Metabolism Ratio",
  "Only.Menthol" = "Exclusive Mentholated Cigarette User",
  "readiness" = "Baseline readiness to quit smoking"
)

# Rename variables in the summary table
missing_summary <- missing_summary %>%
  mutate(Variable = recode(Variable, !!!variable_names))


# Create and display the table
missing_summary %>%
  arrange(desc(Pct)) %>%
  mutate(Pct = sprintf("%.2f%%", Pct)) %>%
  kable(col.names = c("Variable", "Number", "Pct"), caption = "Summary of Missing Values")
```


### Analysis Methods

## \textcolor{orange}{RESULTS}

## \textcolor{orange}{CONCLUSION}

## \textcolor{orange}{LIMITATIONS}

## Data Privacy and Code Availability

Primary data were provided by Dr. George Papandonatos from the Department of Biostatistics at Brown University. The original data cannot be shared directly for privacy. Replication scripts are available at <https://github.com/YanweiTong-Iris/PHP2550-Fall24/tree/main/Project2>.

# Reference



\pagebreak

# Figure Appendix

\pagebreak

# Code Appendix

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
